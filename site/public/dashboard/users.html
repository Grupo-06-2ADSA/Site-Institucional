<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | Usuários</title>
  <script src="../js/sessao.js"></script>
  <link rel="shortcut icon" href="img/circle-MindCore-azul.png" type="image/x-icon">
  <link rel="stylesheet" href="users.css">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="style-responsivo.css">
  <link rel="stylesheet" href="modal.css">
</head>

<body onload="validarSessao(),Usuarios()">

  <div class="left-sidebar">

    <img class="imgLogo" src="img/logo-MindCore.png" alt="logo">

    <div class="menu">
      <div class="bloco 1">
        <a onclick="verificarTipo()">
          <img class="imgBloco" src="img/bar-chart.png">
          <p>Dashboard</p>
        </a>
      </div>

      <div class="bloco 2">
        <a href="verificarNotebooks.html">
          <img class="imgBloco" src="img/computador.png">
          <p>Parque de Máquinas</p>
        </a>
      </div>

      <div class="bloco 3 aqui">
        <a href="users.html">
          <img class="imgBloco" src="img/adicionar-usuario.png">
          <p>Adicionar Usuário</p>
        </a>
      </div>

      <div class="bloco 4">
        <a href="estoque.html">
          <img class="imgBloco" src="img/estoque.png">
          <p>Estoque</p>
        </a>
      </div>
    </div>

    <div class="logout" onclick="limparSessao()">
      <img src="img/sair.png">
    </div>
  </div>
  <div class="dados">
    <div class="perfil">
      <div class="turmas">
        <p>Turmas</p>
        <select name="turmas" id="turma">
          <option value="geral" selected>Geral</option>
      </select>
      </div>

      <div class="usuario">
        <div class="texto">
          <p class="nome" id="nomeUsuario">Olá, </p>
          <p id="tipoUsuario">Administrador</p>
        </div>
        <img src="img/usuario.png">
      </div>
    </div>

    <div class="list" id="list">
      <div class="pesquisar" id="srcUsuario">
        <p>Nome:</p>
        <input id="Pesquisar">
        <button onclick="pesquisarUsuario()">Pesquisar</button>
      </div>
      <div class="header-tabela">

        <span id="nome-users">Nome</span>
        <span id="papel">Cargo</span>
        <span id="status">Status</span>
        <p class="turno-campo">Turno</p>
        <p class="editar-campo"></p>
      </div>
      <div class="list-users" id="listaUsers">
      </div>

      <button onclick="AdicionarUsuario()" class="adicionar">Adicionar</button>

      <div id="modalAdicionar" class="modalUsuario">
        <div class="modal-conteudo">
          <div class="modal-header-usuario">
            <span class="close">&times;</span>
            <div id="header">
              <h2 id="header-title-usuario"></h2>
            </div>
          </div>
          <div class="modal-body-usuario">
            <div class="formulario">
              <div class="campo">
                <span>Nome</span>
                <input type="text" id="nomeFunc">
              </div>
              <div class="campo">
                <span>Email</span>
                <input type="email" id="emailFunc">
              </div>
              <div class="campo">
                <span>Senha</span>
                <input type="password" id="senhaFunc">
              </div>
              <div class="campo">
                <span>Telefone</span>
                <input type="text" maxlength="11" id="telFunc">
              </div>
              <div class="campo">
                <span>Cargo</span>
                <select name="" id="cargoFunc">
                  <option selected disabled value="">Selecionar</option>
                  <option value="Gestor">Gestor</option>
                  <option value="Técnico">Técnico</option>
                </select>
              </div>
              <div class="campo">
                <span>Turno</span>
                <select name="" id="turnoFunc">
                  <option selected disabled value="">Selecionar</option>
                  <option value="manhã">Manhã</option>
                  <option value="tarde">Tarde</option>
                  <option value="noite">Noite</option>
                </select>
              </div>
              <!-- MENSAGEM DE ERRO -->
              <div class="alerta_erro">
                <div class="card_erro" id="cardErro">
                  <span id="mensagem_erro"></span>
                </div>
              </div>
              <div id="div_aguardar" class="loading-div">
                <img src="../assets/img/login-cadastro/aguarde-orange.gif" id="loading-gif" />
              </div>

              <div class="botoes">
                <button class="cancelar">Cancelar</button>
                <button class="adicionar-botao" onclick="adicionarFuncionario()">Adicionar</button>
              </div>
            </div>
          </div>
        </div>

      </div>
      <div id="modalEditar" class="modalUsuario">
        <div class="modal-conteudo">
          <div class="modal-header-usuario">
            <span class="close2">&times;</span>
            <div id="header">
              <h2 id="header-title"></h2>
            </div>
          </div>
          <div class="modal-body-usuario">
            <div class="formulario">
              <div class="campo">
                <span>Nome</span>
                <input type="text" id="nomeFuncEdit">
              </div>
              <div class="campo">
                <span>Email</span>
                <input type="email" id="emailFuncEdit">
              </div>
              <div class="campo">
                <span>Senha</span>
                <input type="password" id="senhaFuncEdit">
              </div>
              <div class="campo">
                <span>Telefone</span>
                <input type="text" maxlength="11" id="telFuncEdit">
              </div>
              <div class="campo" id="statusCampo">
                <span>Status</span>
                <select name="" id="statusFuncEdit">
                  <option selected disabled value="">Selecionar</option>
                  <option value="ativo">Ativo</option>
                  <option value="inativo">Inativo</option>
                </select>
              </div>
              <div class="campo" id="cargo">
                <span>Cargo</span>
                <select name="" id="cargoFuncEdit">
                  <option selected disabled value="">Selecionar</option>
                  <option value="Gestor">Gestor</option>
                  <option value="Técnico">Técnico</option>
                </select>
              </div>
              <div class="campo" id="turno">
                <span>Turno</span>
                <select name="" id="turnoFuncEdit">
                  <option selected disabled value="">Selecionar</option>
                  <option value="manha">Manhã</option>
                  <option value="tarde">Tarde</option>
                  <option value="noite">Noite</option>
                </select>
              </div>
              <!-- MENSAGEM DE ERRO -->
              <div class="alerta_erro">
                <div class="card_erro" id="cardErro">
                  <span id="mensagem_erro_editar"></span>
                </div>
              </div>
              <div id="div_aguardar" class="loading-div">
                <img src="../assets/img/login-cadastro/aguarde-orange.gif" id="loading-gif" />
              </div>

              <div class="botoes">
                <button class="cancelar" onclick="excluirFuncionario()">Excluir</button>
                <button class="adicionar-botao" onclick="salvarAlteracoes()">Salvar Alterações</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

</html>
<script>

  function Usuarios() {
    fetch("/usuarios/listarUsuarios", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        fkEmpresaServer: sessionStorage.EMPRESA_USUARIO
      }),
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO buscar()!")

      if (resposta.ok) {
        console.log(resposta);

        resposta.json().then(json => {
          console.log(json);
          console.log(JSON.stringify(json));

          for (var i = 0; i < json.length; i++) {
            let stringTurno = json[i].turno == 'manha' ? "Manhã" : json[i].turno == 'tarde' ? "Tarde" : "Noite";

            listaUsers.innerHTML += `
            <div class="user" id="0${i}">
                <div class="email">
                    <span id="name">${json[i].nome}</span>
                    <span id="mail">${json[i].email}</span>
                </div>
                <div class="papel">
                    <span>${json[i].tipo}</span>
                </div>
                <div class="status">
                    <span id="status${i}">${json[i].estado}</span>
                </div>
                <div class="turno">
                <span>${stringTurno}</span>  
                </div>
                <div class="edit">
                <a><span class="editar" data-id="${json[i].idFunc}" data-nome="${json[i].nome}" data-email="${json[i].email}" data-senha="${json[i].senha}" data-tel="${json[i].telefone}" data-tipo="${json[i].tipo}" data-turno="${json[i].turno}" data-status="${json[i].estado}" onclick="editarFuncionario(event)">Editar</span> 
                </div></a>
        
            </div>
            `
            if (json[i].estado == "inativo") {
              const elemento = document.getElementById('status' + i);
              elemento.setAttribute("style", "background-color: red;");
            }

            if (i >= 4) {
              listaUsers.style.overflowY = "scroll";
              list.style.overflow = "hidden";
            }

            if (sessionStorage.TIPO_USUARIO == "Técnico") {
              const botao = document.getElementsByClassName("adicionar");
              const editar = document.getElementsByClassName("editar");
              botao[0].disabled = true;
              botao[0].style.opacity = "0.5";
              botao[0].style.cursor = "not-allowed";

              editar[i].disabled = true;
              editar[i].style.opacity = "0.5";
              editar[i].style.cursor = "not-allowed";
            }
          }

        });

      } else {
        console.log("Houve um erro ao tentar realizar o select!");
      }

    }).catch(function (erro) {
      console.log(erro);
    })

    return false;
  }

  let idFunc;

  function salvarAlteracoes() {
    let confirmar = confirm("Você tem certeza que deseja salvar as alterações?");
    if (!confirmar) {
      return;
    }

    let nome = document.getElementById("nomeFuncEdit").value;
    let email = document.getElementById("emailFuncEdit").value;
    let senha = document.getElementById("senhaFuncEdit").value;
    let telefone = document.getElementById("telFuncEdit").value;
    let tipo = document.getElementById("cargoFuncEdit").value;
    let status = document.getElementById("statusFuncEdit").value;
    let turno = document.getElementById("turnoFuncEdit").value;

    fetch("/usuarios/atualizarFuncionario", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        nomeServer: nome,
        emailServer: email,
        senhaServer: senha,
        telefoneServer: telefone,
        tipoServer: tipo,
        statusServer: status,
        turnoServer: turno,
        idFuncionarioServer: idFunc
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
          let cardErro = document.getElementById("cardErro");
          let mensagemErroEditar = document.getElementById("mensagem_erro_editar");

          if (cardErro && mensagemErroEditar) {
            cardErro.style.display = "block";
            mensagemErroEditar.innerHTML = "Alteração realizada com sucesso!";

            setTimeout(() => {
              mensagemErroEditar.innerHTML = "";
              cardErro.style.display = "none";
              location.reload();
            }, 2000);

            limparFormulario();
          } else {
            console.error("Elementos de mensagem de erro não encontrados.");
          }

          limparFormulario();
        } else {
          throw "Houve um erro ao tentar realizar o update!";
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });

    return false;
  }

  function excluirFuncionario() {
    let confirmar = confirm("Você tem certeza que deseja excluir o funcionário?");
    if (!confirmar) {
      return;
    }

    fetch("/usuarios/excluirFuncionario", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        idFuncServer: idFunc
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
          alert("Funcionário excluído com sucesso!")

          location.reload();

        } else {
          throw "Houve um erro ao tentar realizar o delete!";
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });

    return false;
  }

  function pesquisarUsuario() {
    let usuarioPesquisa = Pesquisar.value;

    for (let i = 0; i <= jsonLista.length; i++) {
      if (usuarioPesquisa == jsonLista[i].nome) {
        //graficos(usuarioPesquisa);
        listaUsers.innerHTML = `<div class="user" id="0${i}">
        <div class="email">
            <span id="name">${jsonLista[i].nome}</span>
            <span id="mail">${jsonLista[i].email}</span>
        </div>
        <div class="papel">
            <span>${jsonLista[i].papel}</span>
        </div>
        <div class="status">
            <span id="status${i}">${jsonLista[i].status}</span>

        </div>
        <div class="edit">
          <a href=""><span ">Editar</span></a>
        </div>

        </div>`

        srcUsuario.innerHTML += `<span id="limpar" onclick="LimparPesquisa()">Limpar</span>`;

        break;
      } else {
        Usuarios();
      }
    }
  }

  function LimparPesquisa() {
    Usuarios();
    let limpar = document.getElementById("limpar");

    limpar.style.display = "none";
  }

  let modal = document.getElementById("modalAdicionar");
  let modalEdicao = document.getElementById("modalEditar");
  let span = document.getElementsByClassName("close")[0];
  let span2 = document.getElementsByClassName("close2")[0];
  let button = document.getElementsByClassName("cancelar")

  function AdicionarUsuario() {
    if (sessionStorage.TIPO_USUARIO != "Técnico") {
      let tituloHeader = document.getElementById("header-title-usuario");

      modal.style.display = "block";
      tituloHeader.innerHTML = `Adicionar novo usuário`;
    }
  }

  function editarFuncionario(event) {
    let tituloHeader = document.getElementById("header-title");
    let elemento = event.target;

    let nome = elemento.dataset.nome;
    let email = elemento.dataset.email
    let senha = elemento.dataset.senha;
    let telefone = elemento.dataset.tel;
    let tipo = elemento.dataset.tipo;
    let turno = elemento.dataset.turno;
    let status = elemento.dataset.status;
    idFunc = parseInt(elemento.dataset.id);

    modalEdicao.style.display = "block";
    tituloHeader.innerHTML = `Editar dados Funcionário`;

    let nomeInput = document.getElementById("nomeFuncEdit");
    let emailInput = document.getElementById("emailFuncEdit");
    let senhaInput = document.getElementById("senhaFuncEdit");
    let telInput = document.getElementById("telFuncEdit");
    let tipoInput = document.getElementById("cargoFuncEdit")
    let statusInput = document.getElementById("statusFuncEdit");
    let turnoInput = document.getElementById("turnoFuncEdit");

    nomeInput.value = nome;
    emailInput.value = email;
    senhaInput.value = senha;
    telInput.value = telefone;
    tipoInput.value = tipo;
    statusInput.value = status;
    turnoInput.value = turno;
  }

  span.onclick = function () {
    modal.style.display = "none";
  }

  span2.onclick = function () {
    modalEdicao.style.display = "none;"
  }

  button.onclick = function () {
    modal.style.display = "none";
  }

  window.onclick = function (event) {
    if (event.target == modal) {
      modal.style.display = "none";
    } else if (event.target == modalEdicao) {
      modalEdicao.style.display = "none"
    }
  }
</script>

<!-- CADASTRAR FUNCIONARIO -->
<script>
  function adicionarFuncionario() {
    var nome = nomeFunc.value;
    var email = emailFunc.value;
    var senha = senhaFunc.value;
    var tel = telFunc.value;
    var cargo = cargoFunc.value;
    var turno = turnoFunc.value;
    fetch("/usuarios/cadastrarFuncionarioEmpresa", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        // crie um atributo que recebe o valor recuperado aqui
        // Agora vá para o arquivo routes/usuario.js
        emailServer: email,
        cnpjServer: sessionStorage.EMPRESA_USUARIO,
        nomeServer: nome,
        telefoneServer: tel,
        senhaServer: senha,
        tipoServer: cargo,
        turnoServer: turno
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
          let cardErro = document.getElementById("cardErro");
          let mensagemErroEditar = document.getElementById("mensagem_erro");

          if (cardErro && mensagemErroEditar) {
            cardErro.style.display = "block";
            mensagemErroEditar.innerHTML = "Funcionário cadastrado!";

            setTimeout(() => {
              mensagemErroEditar.innerHTML = "";
              cardErro.style.display = "none";
              location.reload();
            }, 2000);

          } else {
            console.error("Elementos de mensagem de erro não encontrados.");
          }

        } else {
          throw "Houve um erro ao tentar realizar o cadastro!";
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
        finalizarAguardar();
      });
  }

  function sumirMensagem() {
    cardErro.style.display = "none";
  }
</script>